services:
  database:
    image: postgres:18.1-trixie
    container_name: postgres
    restart: unless-stopped

    environment:
      PGDATA: /var/lib/postgresql/data
      POSTGRES_INITDB_ARGS: "--auth-local=scram-sha-256 --auth-host=scram-sha-256"

    command: ["postgres", "-c", "password_encryption=scram-sha-256"]

    env_file:
      - ./database/.env

    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql:ro

    shm_size: "1gb"
    stop_grace_period: 60s

    healthcheck:
      test: ["CMD-SHELL", 'pg_isready -U "$${POSTGRES_USER}" -d "$${POSTGRES_DB}" -h 127.0.0.1']
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 15s

    networks:
      - app

  cache:
    image: redis:8.4.0-alpine
    container_name: redis
    restart: unless-stopped

    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}

    command:
      - redis-server
      - --protected-mode
      - "yes"
      - --maxmemory
      - 256mb
      - --maxmemory-policy
      - volatile-ttl
      - --appendonly
      - "no"
      - --save
      - ""
      - --requirepass
      - "$${REDIS_PASSWORD}"

    stop_grace_period: 30s

    ulimits:
      nofile: 65536

    volumes:
      - redis_data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "-a", "$${REDIS_PASSWORD}", "PING"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 15s

    networks:
      - app

  backend:
    container_name: backend
    restart: unless-stopped

    build:
      context: ./backend
      dockerfile: backend.dockerfile

    ports:
      - "5000:5000"

    depends_on:
      database:
        condition: service_healthy
      cache:
        condition: service_healthy

    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://127.0.0.1:5000/api/health', timeout=2).read()",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 15s

    networks:
      - app

  frontend:
    container_name: frontend
    restart: unless-stopped

    build:
      context: ./frontend
      dockerfile: frontend.dockerfile

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs:/etc/ssl/certs/self:ro

    depends_on:
      backend:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1/healthz"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 15s

    networks:
      - app

  certbot:
    container_name: certbot
    image: certbot/certbot
    restart: unless-stopped
    volumes:
      - certs:/etc/letsencrypt
      - certs-data:/data/letsencrypt
    entrypoint: >
      sh -c "trap exit TERM; while :; do certbot renew --quiet; sleep 12h & wait $${!}; done"

volumes:
  postgres_data:
  redis_data:
  certs:
  certs-data:

networks:
  app:
    driver: bridge
